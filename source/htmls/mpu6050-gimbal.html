<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MPU6050 & èˆµæœºäº‘å°åŸç†å¯è§†åŒ–</title>
    <!-- å¼•å…¥ Three.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; overflow: hidden; background-color: #f3f4f6; font-family: 'Segoe UI', sans-serif; display: flex; flex-direction: column; height: 100vh; }
        
        /* é¡¶éƒ¨æ ‡é¢˜æ  (å›ºå®šé«˜åº¦ 50px) */
        #header {
            height: 50px;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            z-index: 20;
            flex-shrink: 0; /* é˜²æ­¢è¢«å‹ç¼© */
        }

        /* ä¸»å®¹å™¨ (å æ»¡å‰©ä½™é«˜åº¦) */
        #container { 
            display: flex; 
            flex: 1; /* è‡ªåŠ¨å¡«æ»¡å‰©ä½™ç©ºé—´ */
            width: 100vw; 
            position: relative;
        }
        
        .panel { 
            flex: 1; 
            position: relative; 
            border-right: 1px solid #ddd; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            background: #fff;
            overflow: hidden; /* é˜²æ­¢å†…éƒ¨æº¢å‡º */
        }
        
        canvas { display: block; width: 100%; height: 100%; outline: none; }
        
        /* å°æ ‡é¢˜ (ç°åœ¨ä¸ä¼šè¢«é®æŒ¡äº†) */
        .overlay-title {
            position: absolute;
            top: 20px;
            font-size: 1.1rem;
            font-weight: bold;
            color: #374151;
            background: rgba(255, 255, 255, 0.95);
            padding: 6px 16px;
            border-radius: 20px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            z-index: 10;
            border: 1px solid #eee;
        }

        /* æ•°æ®é¢æ¿ */
        .data-panel {
            position: absolute;
            bottom: 60px; /* ç¨å¾®æŠ¬é«˜ï¼Œé¿å¼€åº•éƒ¨è¯´æ˜ */
            left: 20px;
            background: rgba(0, 0, 0, 0.85);
            color: #00ff00;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Consolas', monospace;
            font-size: 0.85rem;
            pointer-events: none;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
            min-width: 220px;
            backdrop-filter: blur(4px);
            z-index: 15;
        }

        /* æ“ä½œæç¤º */
        .instruction {
            position: absolute;
            top: 70px;
            color: #6b7280;
            font-size: 0.9rem;
            background: rgba(255,255,255,0.9);
            padding: 4px 10px;
            border-radius: 4px;
            pointer-events: none;
            z-index: 5;
        }

        /* åº•éƒ¨è§£é‡Šæ¡ */
        #footer-bar {
            height: auto;
            min-height: 40px;
            background: #e0f2fe;
            color: #0c4a6e;
            font-size: 0.85rem;
            padding: 8px 20px;
            border-top: 1px solid #bae6fd;
            z-index: 30;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 768px) {
            #container { flex-direction: column; }
            .panel { border-right: none; border-bottom: 1px solid #ddd; height: 50%; }
            .data-panel { 
                bottom: 10px; 
                left: 10px; 
                padding: 10px;
                font-size: 0.75rem; 
                min-width: auto;
            }
            .overlay-title { top: 10px; font-size: 0.9rem; }
            .instruction { top: 50px; font-size: 0.8rem; }
        }
    </style>
</head>
<body>

    <!-- é¡¶éƒ¨æ ‡é¢˜ -->
    <div id="header">
        <h2 style="margin:0; font-size: 1.1rem; color: #1f2937; font-weight: bold;">
            <i class="fas fa-microchip mr-2 text-blue-600"></i>MPU6050 åŠ é€Ÿåº¦è®¡åŸç†å¯è§†åŒ–
        </h2>
    </div>

    <div id="container">
        <!-- å·¦ä¾§ï¼šä¼ æ„Ÿå™¨æ¨¡æ‹Ÿ -->
        <div class="panel" id="panel-sensor">
            <div class="overlay-title">STM32 & MPU6050 (æ„ŸçŸ¥)</div>
            <div class="instruction"><i class="fas fa-hand-pointer mr-1"></i>æ‹–åŠ¨è“è‰²æ¿å­æ—‹è½¬</div>
            
            <div class="data-panel">
                <div style="margin-bottom:5px; color: #fff; border-bottom:1px solid #555; padding-bottom:3px;">
                    çŠ¶æ€: <span id="status-text">å¹³ç¨³</span>
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <div>
                        <div class="text-gray-400">AX (Xè½´)</div>
                        <div id="raw-ax">0</div>
                    </div>
                    <div>
                        <div class="text-gray-400">AZ (Zè½´)</div>
                        <div id="raw-az">16384</div>
                    </div>
                </div>
                <div style="margin-top:8px; border-top:1px solid #555; padding-top:5px;">
                    <div style="color:#aaa;">è®¡ç®—è§’åº¦ (Pitch):</div>
                    <div style="font-weight:bold; color:#ffcc00; font-size: 1.2em;" id="calc-pitch">0.0Â°</div>
                </div>
            </div>
        </div>

        <!-- å³ä¾§ï¼šæ‰§è¡Œå™¨æ¨¡æ‹Ÿ -->
        <div class="panel" id="panel-actuator">
            <div class="overlay-title">èˆµæœºäº‘å° (æ‰§è¡Œ)</div>
            
            <div class="data-panel" style="left: unset; right: 20px;">
                <div style="margin-bottom:5px; color: #fff; border-bottom:1px solid #555; padding-bottom:3px;">
                    PID ç›®æ ‡: <span style="color:#00ff00">ä¿æŒæ°´å¹³</span>
                </div>
                <div class="space-y-1">
                    <div class="flex justify-between">
                        <span class="text-gray-400">ç›®æ ‡è§’åº¦:</span>
                        <span id="target-angle">0.0Â°</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">PWMå€¼:</span>
                        <span id="pwm-val" class="text-cyan-400">1500</span>
                    </div>
                    <div class="mt-2 text-center bg-gray-700 rounded p-1">
                        <span class="text-xs text-gray-400">èˆµæœºè¾“å‡º</span><br>
                        <span id="servo-angle" class="text-yellow-400 font-bold text-lg">90.0Â°</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- åº•éƒ¨è§£é‡Šæ¡† -->
    <div id="footer-bar">
        <span>
            <strong>ğŸ’¡ åŸç†å›¾è§£ï¼š</strong>
            é‡åŠ›(G)åˆ†è§£åˆ°X/Zè½´ &rarr; MPU6050è¯»å–åˆ†é‡ &rarr; STM32è®¡ç®—å€¾è§’ &rarr; èˆµæœºåå‘æ—‹è½¬æŠµæ¶ˆ
        </span>
    </div>

<script>
    // === åœºæ™¯ 1: MPU6050 ä¼ æ„Ÿå™¨ ===
    const scene1 = new THREE.Scene();
    scene1.background = new THREE.Color(0xffffff); 
    
    const camera1 = new THREE.PerspectiveCamera(45, window.innerWidth / 2 / window.innerHeight, 0.1, 1000);
    camera1.position.set(0, 0, 12);

    const renderer1 = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    // åˆå§‹åŒ–å°ºå¯¸ï¼Œåé¢ resize ä¼šä¿®æ­£
    renderer1.setSize(window.innerWidth / 2, window.innerHeight);
    document.getElementById('panel-sensor').appendChild(renderer1.domElement);

    const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
    scene1.add(ambientLight);
    const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
    dirLight.position.set(5, 10, 7);
    scene1.add(dirLight);

    // --- ç‰©ä½“ï¼šMPU6050 æ¿å­ ---
    const boardGroup = new THREE.Group();
    scene1.add(boardGroup);

    // PCB æ¿
    const pcbGeo = new THREE.BoxGeometry(4, 0.2, 2.5);
    const pcbMat = new THREE.MeshPhongMaterial({ color: 0x2563eb }); 
    const pcb = new THREE.Mesh(pcbGeo, pcbMat);
    boardGroup.add(pcb);

    // èŠ¯ç‰‡
    const chipGeo = new THREE.BoxGeometry(0.8, 0.1, 0.8);
    const chipMat = new THREE.MeshPhongMaterial({ color: 0x111111 });
    const chip = new THREE.Mesh(chipGeo, chipMat);
    chip.position.y = 0.15;
    boardGroup.add(chip);

    // è£…é¥°å¼•è„š
    for(let i=0; i<8; i++) {
        const pin = new THREE.Mesh(new THREE.CylinderGeometry(0.05, 0.05, 0.5), new THREE.MeshStandardMaterial({color: 0xffd700}));
        pin.rotation.x = Math.PI / 2;
        pin.position.set(-1.8 + i*0.5, 0, 1.4);
        boardGroup.add(pin);
    }

    // --- å‘é‡è¾…åŠ©çº¿ ---
    const gravityArrow = new THREE.ArrowHelper(
        new THREE.Vector3(0, -1, 0), 
        new THREE.Vector3(0, 0, 0), 
        3, 0x22c55e, 0.5, 0.3
    );
    scene1.add(gravityArrow); 

    const axisXArrow = new THREE.ArrowHelper(new THREE.Vector3(1, 0, 0), new THREE.Vector3(0,0,0), 2.5, 0xff0000, 0.4, 0.2);
    const axisZArrow = new THREE.ArrowHelper(new THREE.Vector3(0, 0, 1), new THREE.Vector3(0,0,0), 2.5, 0x0000ff, 0.4, 0.2);
    boardGroup.add(axisXArrow);
    boardGroup.add(axisZArrow);

    // === åœºæ™¯ 2: èˆµæœºäº‘å° ===
    const scene2 = new THREE.Scene();
    scene2.background = new THREE.Color(0xf9fafb); 

    const camera2 = new THREE.PerspectiveCamera(45, window.innerWidth / 2 / window.innerHeight, 0.1, 1000);
    camera2.position.set(0, 2, 12);

    const renderer2 = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    renderer2.setSize(window.innerWidth / 2, window.innerHeight);
    document.getElementById('panel-actuator').appendChild(renderer2.domElement);

    const light2 = new THREE.DirectionalLight(0xffffff, 1);
    light2.position.set(2, 5, 5);
    scene2.add(light2);
    scene2.add(new THREE.AmbientLight(0xffffff, 0.5));

    // --- ç‰©ä½“ï¼šèˆµæœºç³»ç»Ÿ ---
    const gimbalGroup = new THREE.Group();
    scene2.add(gimbalGroup);

    const base = new THREE.Mesh(new THREE.CylinderGeometry(1, 1.2, 0.5, 32), new THREE.MeshStandardMaterial({ color: 0x4b5563 }));
    base.position.y = -2;
    scene2.add(base);

    const servoBody = new THREE.Mesh(new THREE.BoxGeometry(2, 3, 1.5), new THREE.MeshStandardMaterial({ color: 0x333333 }));
    servoBody.position.y = -0.5;
    scene2.add(servoBody); 

    const axisMesh = new THREE.Mesh(new THREE.CylinderGeometry(0.3, 0.3, 0.5, 16), new THREE.MeshStandardMaterial({ color: 0xffffff }));
    axisMesh.rotation.x = Math.PI / 2; 
    axisMesh.position.y = 0.5;
    scene2.add(axisMesh);

    const armGroup = new THREE.Group();
    armGroup.position.y = 0.5; 
    scene2.add(armGroup);

    const link = new THREE.Mesh(new THREE.BoxGeometry(3, 0.2, 0.5), new THREE.MeshStandardMaterial({ color: 0xff8c00 }));
    armGroup.add(link);

    const cam = new THREE.Mesh(new THREE.BoxGeometry(1, 0.8, 1), new THREE.MeshStandardMaterial({ color: 0x000000 }));
    cam.position.set(1.5, 0.5, 0); 
    armGroup.add(cam);
    
    const lens = new THREE.Mesh(new THREE.CylinderGeometry(0.3, 0.3, 0.2, 16), new THREE.MeshStandardMaterial({color: 0x22c55e}));
    lens.rotation.x = Math.PI/2;
    lens.position.set(1.5, 0.5, 0.5);
    armGroup.add(lens);

    const lineGeo = new THREE.BufferGeometry().setFromPoints([new THREE.Vector3(-5, 0.5, 0), new THREE.Vector3(5, 0.5, 0)]);
    const lineMat = new THREE.LineDashedMaterial({ color: 0xcccccc, dashSize: 0.2, gapSize: 0.1 });
    const refLine = new THREE.Line(lineGeo, lineMat);
    refLine.computeLineDistances();
    scene2.add(refLine);


    // === äº¤äº’é€»è¾‘ ===
    let isDragging = false;
    let currentPitch = 0; 
    const sensorPanel = document.getElementById('panel-sensor');
    
    sensorPanel.addEventListener('mousedown', () => { isDragging = true; sensorPanel.style.cursor = 'grabbing'; });
    window.addEventListener('mouseup', () => { isDragging = false; sensorPanel.style.cursor = 'grab'; });

    window.addEventListener('mousemove', (e) => {
        if (!isDragging) return;
        const deltaY = e.movementY || e.mozMovementY || e.webkitMovementY || 0;
        let newPitch = currentPitch + deltaY * 0.01;
        newPitch = Math.max(-0.8, Math.min(0.8, newPitch));
        currentPitch = newPitch;
    });

    // è§¦æ‘¸æ”¯æŒ
    let touchStartY = 0;
    sensorPanel.addEventListener('touchstart', (e) => { isDragging = true; touchStartY = e.touches[0].clientY; });
    sensorPanel.addEventListener('touchmove', (e) => {
        if(!isDragging) return;
        const deltaY = e.touches[0].clientY - touchStartY;
        touchStartY = e.touches[0].clientY;
        let newPitch = currentPitch + deltaY * 0.01;
        newPitch = Math.max(-0.8, Math.min(0.8, newPitch));
        currentPitch = newPitch;
        e.preventDefault();
    });
    window.addEventListener('touchend', () => isDragging = false);


    // === åŠ¨ç”»å¾ªç¯ ===
    function animate() {
        requestAnimationFrame(animate);

        // 1. è®¾ç½®æ¿å­æ—‹è½¬
        boardGroup.rotation.x = currentPitch;

        // 2. æ¨¡æ‹Ÿè®¡ç®—
        const angleDeg = currentPitch * (180 / Math.PI);
        const gravity = 16384; 
        const raw_az = Math.cos(currentPitch) * gravity;
        const raw_ax = Math.sin(currentPitch) * gravity; 

        // 3. æ›´æ–° UI
        document.getElementById('raw-ax').innerText = Math.round(raw_ax);
        document.getElementById('raw-az').innerText = Math.round(raw_az);
        document.getElementById('calc-pitch').innerText = (-angleDeg).toFixed(1) + "Â°";
        
        const status = Math.abs(angleDeg) < 2 ? "å¹³ç¨³" : (angleDeg > 0 ? "å‰å€¾" : "åä»°");
        const statusEl = document.getElementById('status-text');
        statusEl.innerText = status;
        statusEl.style.color = status === "å¹³ç¨³" ? "#00ff00" : "#ff4444";

        // 4. èˆµæœºæ§åˆ¶
        // åå‘æ—‹è½¬ä»¥ä¿æŒæ°´å¹³
        armGroup.rotation.z = -currentPitch; 

        const servoAngle = 90 + (-angleDeg);
        document.getElementById('servo-angle').innerText = servoAngle.toFixed(1) + "Â°";
        document.getElementById('target-angle').innerText = (-angleDeg).toFixed(1) + "Â°";
        const pwm = 1500 + ((-angleDeg) / 90) * 1000;
        document.getElementById('pwm-val').innerText = Math.round(pwm);

        renderer1.render(scene1, camera1);
        renderer2.render(scene2, camera2);
    }

    animate();

    // === çª—å£è‡ªé€‚åº” (å…³é”®ä¿®å¤) ===
    function onWindowResize() {
        const container = document.getElementById('container');
        // è·å–é¢æ¿çš„å®é™…å¤§å°ï¼Œè€Œä¸æ˜¯å±å¹•å¤§å°
        const panelWidth = container.clientWidth / 2;
        const panelHeight = container.clientHeight;
        
        camera1.aspect = panelWidth / panelHeight;
        camera1.updateProjectionMatrix();
        renderer1.setSize(panelWidth, panelHeight);

        camera2.aspect = panelWidth / panelHeight;
        camera2.updateProjectionMatrix();
        renderer2.setSize(panelWidth, panelHeight);
    }
    
    // åˆå§‹åŒ–è°ƒç”¨ä¸€æ¬¡ï¼Œç¡®ä¿å¤§å°æ­£ç¡®
    onWindowResize();
    window.addEventListener('resize', onWindowResize);

</script>
</body>
</html>